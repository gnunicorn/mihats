(function() {
  function getXMLHttpRequest() {
      if (window.XMLHttpRequest) {
          return new window.XMLHttpRequest();
      }
      else {
          try {
              return new ActiveXObject("MSXML2.XMLHTTP"); 
          }
          catch(ex) {
              return null;
          }
      }
    }

    var DEFAULT_URL = "http://www.mihats.com/api/v1/profile/?profile_name=";

  window.getMiHats = function getMiHats(profileId, callback, custom_url) {
    var url = (custom_url || DEFAULT_URL) + profileId;
    var xml = getXMLHttpRequest();

    xml.open("GET", url, true);
    xml.onreadystatechange = function() {
        console.log(xml);
        if (xml.readyState == 4) {
          if (xml.status === 200){
              return callback(JSON.parse(xml.responseText).result, profileId);
            } else {
              alert("Can't load MiHats Profile. Are you sure this Website is allowed to load the content?");
            }
        }
    };
    xml.send();
  };

  var elem = document.getElementById("mihats");
  console.log(elem);
  if(!elem) return;

  function formatHats(hats) {
    var profiles = [];
    for (var x=0; x < hats.length; x++){
      var hat = hats[x];
      var src = ["<li>"];
      if (hat.what_link) src.push('<a class="mihats-what-link" href="' + hat.what_link + '"><span class="mihats-what">' + hat.what + '</span></a>');
      else src.push('<span class="mihats-what">' + hat.what + '</span>');

      src.push(hat.preposition || "at");

      if (hat.where_link) src.push('<a class="mihats-where-lin" href="' + hat.where_link + '"><span class="mihats-where">' + hat.where + '</span></a>');
      else src.push('<span class="mihats-where">' + hat.where + '</span>');

      if (hat.since) src.push('<span class="mihats-since"> since: ' + hat.since + '</span>');

      src.push("</li>");
      profiles.push(src.join(" "));
    }
    return profiles.join("\n");
  }
  window.renderMiHats = function renderWidget(resp){

    var html = '<a href="' +
                (resp.profile_link || ('http://www.mihats.com/#/' + resp.profile_name) ) +
                '" class="mihats-profile">' + resp.profile_name + '</a> \' hats:' +
            '<ul class="mihats-hats-current">' + formatHats(resp.current_hats) + '</ul>';

    if (elem.dataset.formerhats && resp.former_hats.length) {
        html += '<span>former hats:</span>' + '<ul class="mihats-hats-former">' +
                formatHats(resp.former_hats) + '</ul>';
    }

    elem.innerHTML =  html +
            '<p class="mihats-credits">generated by <a href="http://www.mihats.com">miHats.com</a><p>';
  };

  getMiHats(elem.dataset.profileid, renderMiHats , "/api/v1/profile/?profile_name=");
})();